<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monthly Budget</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA / Home Screen related -->
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- iOS specific -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Budget" />
  <!-- Optional icon (you can create icons/icon-192.png later) -->
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
    }
    .app {
      max-width: 700px;
      margin: 0 auto;
      background: #ffffff;
      padding: 1rem 1.5rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    h1, h2 {
      margin-top: 0.5rem;
      margin-bottom: 0.75rem;
    }
    label {
      font-size: 0.9rem;
      font-weight: 500;
    }
    input[type="number"], input[type="text"] {
      width: 100%;
      padding: 0.4rem 0.5rem;
      margin-top: 0.25rem;
      margin-bottom: 0.75rem;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
    }
    .row {
      display: flex;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1 1 0;
      min-width: 120px;
    }
    button {
      border: none;
      border-radius: 4px;
      padding: 0.4rem 0.75rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-primary {
      background: #2563eb;
      color: white;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.35rem 0.4rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      font-weight: 600;
      background: #f9fafb;
    }
    .right {
      text-align: right;
      white-space: nowrap;
    }
    .summary {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 6px;
      background: #f9fafb;
      font-size: 0.9rem;
    }
    .summary strong {
      font-size: 1rem;
    }
    .muted {
      color: #6b7280;
      font-size: 0.85rem;
    }
    .tag {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 0.75rem;
      margin-left: 0.35rem;
    }
    @media (max-width: 480px) {
      h1 {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Monthly Budget</h1>
    <p class="muted" id="monthInfo"></p>

    <!-- Income -->
    <section>
      <h2>Income</h2>
      <label for="incomeInput">Total monthly income</label>
      <input type="number" id="incomeInput" placeholder="e.g. 4000" step="0.01" />
    </section>

    <!-- Expenses -->
    <section>
      <h2>Expenses</h2>
      <div id="expensesContainer"></div>
      <button class="btn-secondary" id="addExpenseBtn">+ Add Expense</button>
    </section>

    <!-- Actions -->
    <section style="margin-top: 1rem;">
      <button class="btn-primary" id="calcBtn">Recalculate</button>
      <button class="btn-secondary" id="resetBtn" style="margin-left:0.5rem;">Reset saved data</button>
      <span class="muted" style="margin-left: 0.5rem;">Settings save automatically on this device.</span>
    </section>

    <!-- Results -->
    <section class="summary" id="summarySection" style="display:none;">
      <div id="progressText"></div>
      <div style="margin-top:0.5rem;">
        <strong>Totals for entire month</strong>
        <div>Income: <span id="totalIncome"></span></div>
        <div>Expenses: <span id="totalExpenses"></span></div>
        <div>Net (month): <span id="netMonth"></span></div>
      </div>
      <hr style="margin:0.75rem 0;border:none;border-top:1px solid #e5e7eb;">
      <div>
        <strong>“Paid amount” as of today</strong>
        <div>Income earned so far: <span id="incomeSoFar"></span></div>
        <div>Expenses due so far: <span id="expensesSoFar"></span></div>
        <div>Net as of today: <span id="netToday"></span></div>
      </div>
    </section>

    <!-- Expense breakdown -->
    <section id="expenseTableSection" style="margin-top:1rem; display:none;">
      <h2>Expense breakdown<span class="tag">prorated to today</span></h2>
      <table>
        <thead>
          <tr>
            <th>Expense</th>
            <th class="right">Monthly</th>
            <th class="right">Paid so far</th>
          </tr>
        </thead>
        <tbody id="expenseTableBody"></tbody>
      </table>
    </section>
  </div>

  <script>
    // ---- PWA: service worker registration ----
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .catch(err => console.warn('SW registration failed:', err));
      });
    }

    // ---- Date & month info ----
    const today = new Date();
    const year = today.getFullYear();
    const monthIndex = today.getMonth(); // 0-based
    const day = today.getDate();
    const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
    const fractionOfMonth = day / daysInMonth;

    const monthNames = [
      "January","February","March","April","May","June",
      "July","August","September","October","November","December"
    ];
    const monthInfoEl = document.getElementById("monthInfo");
    monthInfoEl.textContent =
      `${monthNames[monthIndex]} ${year} — Day ${day} of ${daysInMonth} ` +
      `(${(fractionOfMonth * 100).toFixed(1)}% through the month)`;

    // ---- Elements ----
    const incomeInput = document.getElementById("incomeInput");
    const expensesContainer = document.getElementById("expensesContainer");
    const addExpenseBtn = document.getElementById("addExpenseBtn");
    const calcBtn = document.getElementById("calcBtn");
    const resetBtn = document.getElementById("resetBtn");

    const summarySection = document.getElementById("summarySection");
    const expenseTableSection = document.getElementById("expenseTableSection");
    const expenseTableBody = document.getElementById("expenseTableBody");

    const totalIncomeEl = document.getElementById("totalIncome");
    const totalExpensesEl = document.getElementById("totalExpenses");
    const netMonthEl = document.getElementById("netMonth");
    const incomeSoFarEl = document.getElementById("incomeSoFar");
    const expensesSoFarEl = document.getElementById("expensesSoFar");
    const netTodayEl = document.getElementById("netToday");
    const progressTextEl = document.getElementById("progressText");

    const STORAGE_KEY = "simpleMonthlyBudget_v1";

    function formatMoney(value) {
      if (isNaN(value)) value = 0;
      return "$" + value.toFixed(2);
    }

    // ---- State helpers (save / load) ----
    function getCurrentExpenses() {
      const expenseRows = expensesContainer.querySelectorAll(".row");
      const expenses = [];
      expenseRows.forEach(row => {
        const inputs = row.querySelectorAll("input");
        const name = (inputs[0]?.value || "").trim();
        const amount = inputs[1]?.value || "";
        if (name !== "" || amount !== "") {
          expenses.push({ name, amount });
        }
      });
      return expenses;
    }

    function saveState() {
      const data = {
        income: incomeInput.value || "",
        expenses: getCurrentExpenses()
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.warn("Unable to save budget data:", e);
      }
    }

    function loadState() {
      let data = null;
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) data = JSON.parse(raw);
      } catch (e) {
        console.warn("Unable to load budget data:", e);
      }

      if (data && typeof data === "object") {
        incomeInput.value = data.income || "";
        expensesContainer.innerHTML = "";
        const list = Array.isArray(data.expenses) ? data.expenses : [];
        if (list.length > 0) {
          list.forEach(e => {
            addExpenseRow(e.name || "", e.amount || "");
          });
        } else {
          addExpenseRow("Rent");
          addExpenseRow("Groceries");
        }
      } else {
        expensesContainer.innerHTML = "";
        addExpenseRow("Rent");
        addExpenseRow("Groceries");
      }
    }

    // ---- UI creation ----
    function addExpenseRow(name = "", amount = "") {
      const row = document.createElement("div");
      row.className = "row";

      const nameDiv = document.createElement("div");
      const amountDiv = document.createElement("div");
      const buttonDiv = document.createElement("div");

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "Name (rent, groceries, etc.)";
      nameInput.value = name;

      const amountInput = document.createElement("input");
      amountInput.type = "number";
      amountInput.placeholder = "Amount";
      amountInput.step = "0.01";
      amountInput.value = amount;

      const removeBtn = document.createElement("button");
      removeBtn.className = "btn-danger";
      removeBtn.textContent = "Remove";
      removeBtn.onclick = () => {
        expensesContainer.removeChild(row);
        saveState();
      };

      nameInput.addEventListener("input", saveState);
      amountInput.addEventListener("input", saveState);

      nameDiv.appendChild(nameInput);
      amountDiv.appendChild(amountInput);
      buttonDiv.appendChild(removeBtn);

      row.appendChild(nameDiv);
      row.appendChild(amountDiv);
      row.appendChild(buttonDiv);

      expensesContainer.appendChild(row);
    }

    // ---- Event handlers ----
    addExpenseBtn.addEventListener("click", () => {
      addExpenseRow();
      saveState();
    });

    incomeInput.addEventListener("input", saveState);

    calcBtn.addEventListener("click", () => {
      saveState();

      const income = parseFloat(incomeInput.value) || 0;

      const expenseRows = expensesContainer.querySelectorAll(".row");
      const expenses = [];
      expenseRows.forEach(row => {
        const inputs = row.querySelectorAll("input");
        const name = (inputs[0]?.value || "").trim() || "Unnamed";
        const amount = parseFloat(inputs[1]?.value) || 0;
        if (amount > 0) {
          expenses.push({ name, amount });
        }
      });

      const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
      const netMonth = income - totalExpenses;

      const incomeSoFar = income * fractionOfMonth;
      const expensesSoFar = totalExpenses * fractionOfMonth;
      const netToday = incomeSoFar - expensesSoFar;

      summarySection.style.display = "block";
      progressTextEl.textContent =
        `Assuming income and expenses are spread evenly across the month, ` +
        `these are your pro-rated amounts as of today.`;

      totalIncomeEl.textContent = formatMoney(income);
      totalExpensesEl.textContent = formatMoney(totalExpenses);
      netMonthEl.textContent = formatMoney(netMonth);

      incomeSoFarEl.textContent = formatMoney(incomeSoFar);
      expensesSoFarEl.textContent = formatMoney(expensesSoFar);
      netTodayEl.textContent = formatMoney(netToday);

      expenseTableBody.innerHTML = "";
      expenses.forEach(e => {
        const tr = document.createElement("tr");
        const tdName = document.createElement("td");
        const tdMonth = document.createElement("td");
        const tdSoFar = document.createElement("td");

        tdName.textContent = e.name;
        tdMonth.className = "right";
        tdSoFar.className = "right";

        tdMonth.textContent = formatMoney(e.amount);
        tdSoFar.textContent = formatMoney(e.amount * fractionOfMonth);

        tr.appendChild(tdName);
        tr.appendChild(tdMonth);
        tr.appendChild(tdSoFar);
        expenseTableBody.appendChild(tr);
      });

      expenseTableSection.style.display = expenses.length ? "block" : "none";
    });

    resetBtn.addEventListener("click", () => {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {
        console.warn("Unable to clear budget data:", e);
      }
      incomeInput.value = "";
      expensesContainer.innerHTML = "";
      addExpenseRow("Rent");
      addExpenseRow("Groceries");
      summarySection.style.display = "none";
      expenseTableSection.style.display = "none";
    });

    // ---- Initialize ----
    loadState();
  </script>
</body>
</html>
