<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monthly Budget</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA / Home Screen related -->
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- iOS specific -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Budget" />
  <!-- Optional icon (you can create icons/icon-192.png later) -->
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
    }
    .app {
      max-width: 900px;
      margin: 0 auto;
      background: #ffffff;
      padding: 1rem 1.5rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    h1, h2, h3 {
      margin-top: 0.5rem;
      margin-bottom: 0.75rem;
    }
    label {
      font-size: 0.9rem;
      font-weight: 500;
    }
    input[type="number"],
    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      padding: 0.35rem 0.45rem;
      margin-top: 0.2rem;
      margin-bottom: 0.45rem;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    .row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.3rem;
      flex-wrap: wrap;
    }
    .col-name {
      flex: 1 1 160px;
      min-width: 140px;
    }
    .col-amount {
      flex: 0 0 110px;
      min-width: 90px;
    }
    .col-date {
      flex: 0 0 130px;
      min-width: 110px;
    }
    .col-freq {
      flex: 0 0 130px;
      min-width: 110px;
    }
    .col-btn {
      flex: 0 0 80px;
      min-width: 70px;
    }
    button {
      border: none;
      border-radius: 4px;
      padding: 0.4rem 0.75rem;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-primary {
      background: #2563eb;
      color: white;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.35rem 0.4rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      font-weight: 600;
      background: #f9fafb;
    }
    .right {
      text-align: right;
      white-space: nowrap;
    }
    .center {
      text-align: center;
      white-space: nowrap;
    }
    .summary {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 6px;
      background: #f9fafb;
      font-size: 0.9rem;
    }
    .summary strong {
      font-size: 1rem;
    }
    .muted {
      color: #6b7280;
      font-size: 0.85rem;
    }
    .tag {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 0.75rem;
      margin-left: 0.35rem;
    }
    @media (max-width: 480px) {
      h1 {
        font-size: 1.3rem;
      }
      th, td {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Monthly Budget</h1>
    <p class="muted" id="monthInfo"></p>

    <!-- Incomes -->
    <section>
      <h2>Incomes</h2>
      <p class="muted">
        For each income, enter the amount you receive each time, the <strong>next payday</strong>,
        and how often it repeats. Items without a date are treated as spread across the month.
      </p>
      <div id="incomeContainer"></div>
      <button class="btn-secondary" id="addIncomeBtn">+ Add Income</button>
    </section>

    <!-- Expenses -->
    <section style="margin-top:1rem;">
      <h2>Expenses</h2>
      <p class="muted">
        Same idea: enter each bill/expense with amount, next due date, and how often it repeats.
        Blank date = spread evenly across the month.
      </p>
      <div id="expensesContainer"></div>
      <button class="btn-secondary" id="addExpenseBtn">+ Add Expense</button>
    </section>

    <!-- Actions -->
    <section style="margin-top: 1rem;">
      <button class="btn-primary" id="calcBtn">Recalculate</button>
      <button class="btn-secondary" id="resetBtn" style="margin-left:0.5rem;">Reset saved data</button>
      <span class="muted" style="margin-left: 0.5rem;">Settings save automatically on this device.</span>
    </section>

    <!-- Results -->
    <section class="summary" id="summarySection" style="display:none;">
      <div id="progressText"></div>
      <div style="margin-top:0.5rem;">
        <strong>Totals for this month</strong>
        <div>Income (this month): <span id="totalIncome"></span></div>
        <div>Expenses (this month): <span id="totalExpenses"></span></div>
        <div>Net (month): <span id="netMonth"></span></div>
      </div>
      <hr style="margin:0.75rem 0;border:none;border-top:1px solid #e5e7eb;">
      <div>
        <strong>As of today</strong>
        <div>Income received so far: <span id="incomeSoFar"></span></div>
        <div>Expenses due so far: <span id="expensesSoFar"></span></div>
        <div>Net as of today: <span id="netToday"></span></div>
      </div>
    </section>

    <!-- Income breakdown -->
    <section id="incomeTableSection" style="margin-top:1rem; display:none;">
      <h3>Income breakdown<span class="tag">by date & frequency</span></h3>
      <table>
        <thead>
          <tr>
            <th>Income</th>
            <th class="center">Next date</th>
            <th class="center">Frequency</th>
            <th class="right">This month</th>
            <th class="right">Paid so far</th>
          </tr>
        </thead>
        <tbody id="incomeTableBody"></tbody>
      </table>
    </section>

    <!-- Expense breakdown -->
    <section id="expenseTableSection" style="margin-top:1rem; display:none;">
      <h3>Expense breakdown<span class="tag">by date & frequency</span></h3>
      <table>
        <thead>
          <tr>
            <th>Expense</th>
            <th class="center">Next date</th>
            <th class="center">Frequency</th>
            <th class="right">This month</th>
            <th class="right">Paid so far</th>
          </tr>
        </thead>
        <tbody id="expenseTableBody"></tbody>
      </table>
    </section>
  </div>

  <script>
    // ---- PWA: service worker registration ----
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js")
          .catch(err => console.warn("SW registration failed:", err));
      });
    }

    // ---- Date & month info ----
    const today = new Date();
    const year = today.getFullYear();
    const monthIndex = today.getMonth(); // 0-based
    const day = today.getDate();
    const firstDayOfMonth = new Date(year, monthIndex, 1);
    const lastDayOfMonth = new Date(year, monthIndex + 1, 0);
    const daysInMonth = lastDayOfMonth.getDate();
    const fractionOfMonth = day / daysInMonth;

    const monthNames = [
      "January","February","March","April","May","June",
      "July","August","September","October","November","December"
    ];
    const monthInfoEl = document.getElementById("monthInfo");
    monthInfoEl.textContent =
      `${monthNames[monthIndex]} ${year} — Day ${day} of ${daysInMonth} ` +
      `(${(fractionOfMonth * 100).toFixed(1)}% through the month)`;

    // ---- Elements ----
    const incomeContainer = document.getElementById("incomeContainer");
    const expensesContainer = document.getElementById("expensesContainer");
    const addIncomeBtn = document.getElementById("addIncomeBtn");
    const addExpenseBtn = document.getElementById("addExpenseBtn");
    const calcBtn = document.getElementById("calcBtn");
    const resetBtn = document.getElementById("resetBtn");

    const summarySection = document.getElementById("summarySection");
    const incomeTableSection = document.getElementById("incomeTableSection");
    const expenseTableSection = document.getElementById("expenseTableSection");
    const incomeTableBody = document.getElementById("incomeTableBody");
    const expenseTableBody = document.getElementById("expenseTableBody");

    const totalIncomeEl = document.getElementById("totalIncome");
    const totalExpensesEl = document.getElementById("totalExpenses");
    const netMonthEl = document.getElementById("netMonth");
    const incomeSoFarEl = document.getElementById("incomeSoFar");
    const expensesSoFarEl = document.getElementById("expensesSoFar");
    const netTodayEl = document.getElementById("netToday");
    const progressTextEl = document.getElementById("progressText");

    const STORAGE_KEY = "simpleMonthlyBudget_v3";

    const FREQ_LABELS = {
      monthly: "Monthly",
      weekly: "Every week",
      biweekly: "Every 2 weeks",
      once: "Once",
      prorated: "Prorated"
    };

    function formatMoney(value) {
      if (isNaN(value)) value = 0;
      return "$" + value.toFixed(2);
    }

    function formatDateDisplay(d) {
      if (!d || isNaN(d)) return "–";
      const m = d.getMonth() + 1;
      const dd = d.getDate();
      return `${m}/${dd}`;
    }

    function addDays(base, days) {
      const d = new Date(base);
      d.setDate(d.getDate() + days);
      return d;
    }

    function addMonths(base, months) {
      const d = new Date(base);
      const targetDay = d.getDate();
      d.setMonth(d.getMonth() + months);
      // handle short months by snapping to last day
      if (d.getDate() < targetDay) {
        d.setDate(0);
      }
      return d;
    }

    // Occurrences within current month for weekly/biweekly
    function getOccurrencesStepDays(baseDate, stepDays) {
      const occ = [];
      if (!baseDate || isNaN(baseDate)) return occ;

      // Step backwards from base until well before this month
      let d = new Date(baseDate);
      const minDate = new Date(firstDayOfMonth);
      minDate.setDate(minDate.getDate() - stepDays * 3);

      while (d >= minDate) {
        if (d >= firstDayOfMonth && d <= lastDayOfMonth) {
          occ.push(new Date(d));
        }
        d = addDays(d, -stepDays);
      }

      // Step forwards
      d = addDays(baseDate, stepDays);
      const maxDate = new Date(lastDayOfMonth);
      maxDate.setDate(maxDate.getDate() + stepDays * 3);

      while (d <= maxDate) {
        if (d >= firstDayOfMonth && d <= lastDayOfMonth) {
          occ.push(new Date(d));
        }
        d = addDays(d, stepDays);
      }

      occ.sort((a, b) => a - b);
      return occ;
    }

    // Occurrences within current month for monthly frequency
    function getMonthlyOccurrences(baseDate) {
      const occ = [];
      if (!baseDate || isNaN(baseDate)) return occ;

      let d = new Date(baseDate);
      // step backwards
      while (d >= firstDayOfMonth) {
        if (d <= lastDayOfMonth) {
          occ.push(new Date(d));
        }
        d = addMonths(d, -1);
      }
      // step forwards
      d = addMonths(baseDate, 1);
      while (d <= lastDayOfMonth) {
        if (d >= firstDayOfMonth) {
          occ.push(new Date(d));
        }
        d = addMonths(d, 1);
      }

      occ.sort((a, b) => a - b);
      return occ;
    }

    // ---- State helpers (save / load) ----
    function getCurrentIncomes() {
      const rows = incomeContainer.querySelectorAll(".income-row");
      const items = [];
      rows.forEach(row => {
        const nameInput = row.querySelector(".name-input");
        const amountInput = row.querySelector(".amount-input");
        const dateInput = row.querySelector(".date-input");
        const freqSelect = row.querySelector(".freq-select");
        const name = (nameInput?.value || "").trim();
        const amount = amountInput?.value || "";
        const nextDate = dateInput?.value || "";
        const freq = freqSelect?.value || "monthly";
        if (name !== "" || amount !== "" || nextDate !== "") {
          items.push({ name, amount, nextDate, freq });
        }
      });
      return items;
    }

    function getCurrentExpenses() {
      const rows = expensesContainer.querySelectorAll(".expense-row");
      const items = [];
      rows.forEach(row => {
        const nameInput = row.querySelector(".name-input");
        const amountInput = row.querySelector(".amount-input");
        const dateInput = row.querySelector(".date-input");
        const freqSelect = row.querySelector(".freq-select");
        const name = (nameInput?.value || "").trim();
        const amount = amountInput?.value || "";
        const nextDate = dateInput?.value || "";
        const freq = freqSelect?.value || "monthly";
        if (name !== "" || amount !== "" || nextDate !== "") {
          items.push({ name, amount, nextDate, freq });
        }
      });
      return items;
    }

    function saveState() {
      const data = {
        incomes: getCurrentIncomes(),
        expenses: getCurrentExpenses()
      };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.warn("Unable to save budget data:", e);
      }
    }

    function loadState() {
      let data = null;
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) data = JSON.parse(raw);
      } catch (e) {
        console.warn("Unable to load budget data:", e);
      }

      incomeContainer.innerHTML = "";
      expensesContainer.innerHTML = "";

      if (data && typeof data === "object") {
        const incomes = Array.isArray(data.incomes) ? data.incomes : [];
        const expenses = Array.isArray(data.expenses) ? data.expenses : [];

        if (incomes.length > 0) {
          incomes.forEach(i =>
            addIncomeRow(i.name || "", i.amount || "", i.nextDate || "", i.freq || "monthly")
          );
        } else {
          addIncomeRow("Paycheck", "", "", "biweekly");
        }

        if (expenses.length > 0) {
          expenses.forEach(e =>
            addExpenseRow(e.name || "", e.amount || "", e.nextDate || "", e.freq || "monthly")
          );
        } else {
          addExpenseRow("Rent", "", "", "monthly");
          addExpenseRow("Groceries", "", "", "weekly");
        }
      } else {
        addIncomeRow("Paycheck", "", "", "biweekly");
        addExpenseRow("Rent", "", "", "monthly");
        addExpenseRow("Groceries", "", "", "weekly");
      }
    }

    // ---- UI row creation ----
    function createFreqSelect(initial) {
      const select = document.createElement("select");
      select.className = "freq-select";
      const options = [
        { value: "monthly", label: "Monthly" },
        { value: "biweekly", label: "Every 2 weeks" },
        { value: "weekly", label: "Every week" },
        { value: "once", label: "Once" }
      ];
      options.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.label;
        select.appendChild(o);
      });
      select.value = initial && options.some(o => o.value === initial)
        ? initial
        : "monthly";
      return select;
    }

    function addIncomeRow(name = "", amount = "", nextDate = "", freq = "monthly") {
      const row = document.createElement("div");
      row.className = "row income-row";

      const nameDiv = document.createElement("div");
      nameDiv.className = "col-name";
      const amountDiv = document.createElement("div");
      amountDiv.className = "col-amount";
      const dateDiv = document.createElement("div");
      dateDiv.className = "col-date";
      const freqDiv = document.createElement("div");
      freqDiv.className = "col-freq";
      const buttonDiv = document.createElement("div");
      buttonDiv.className = "col-btn";

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "Name (paycheck, side job, etc.)";
      nameInput.value = name;
      nameInput.className = "name-input";

      const amountInput = document.createElement("input");
      amountInput.type = "number";
      amountInput.placeholder = "Amount per pay";
      amountInput.step = "0.01";
      amountInput.value = amount;
      amountInput.className = "amount-input";

      const dateInput = document.createElement("input");
      dateInput.type = "date";
      dateInput.value = nextDate;
      dateInput.className = "date-input";

      const freqSelect = createFreqSelect(freq);

      const removeBtn = document.createElement("button");
      removeBtn.className = "btn-danger";
      removeBtn.textContent = "Remove";
      removeBtn.onclick = () => {
        incomeContainer.removeChild(row);
        saveState();
      };

      nameInput.addEventListener("input", saveState);
      amountInput.addEventListener("input", saveState);
      dateInput.addEventListener("input", saveState);
      freqSelect.addEventListener("change", saveState);

      nameDiv.appendChild(nameInput);
      amountDiv.appendChild(amountInput);
      dateDiv.appendChild(dateInput);
      freqDiv.appendChild(freqSelect);
      buttonDiv.appendChild(removeBtn);

      row.appendChild(nameDiv);
      row.appendChild(amountDiv);
      row.appendChild(dateDiv);
      row.appendChild(freqDiv);
      row.appendChild(buttonDiv);

      incomeContainer.appendChild(row);
    }

    function addExpenseRow(name = "", amount = "", nextDate = "", freq = "monthly") {
      const row = document.createElement("div");
      row.className = "row expense-row";

      const nameDiv = document.createElement("div");
      nameDiv.className = "col-name";
      const amountDiv = document.createElement("div");
      amountDiv.className = "col-amount";
      const dateDiv = document.createElement("div");
      dateDiv.className = "col-date";
      const freqDiv = document.createElement("div");
      freqDiv.className = "col-freq";
      const buttonDiv = document.createElement("div");
      buttonDiv.className = "col-btn";

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "Name (rent, groceries, etc.)";
      nameInput.value = name;
      nameInput.className = "name-input";

      const amountInput = document.createElement("input");
      amountInput.type = "number";
      amountInput.placeholder = "Amount per bill";
      amountInput.step = "0.01";
      amountInput.value = amount;
      amountInput.className = "amount-input";

      const dateInput = document.createElement("input");
      dateInput.type = "date";
      dateInput.value = nextDate;
      dateInput.className = "date-input";

      const freqSelect = createFreqSelect(freq);

      const removeBtn = document.createElement("button");
      removeBtn.className = "btn-danger";
      removeBtn.textContent = "Remove";
      removeBtn.onclick = () => {
        expensesContainer.removeChild(row);
        saveState();
      };

      nameInput.addEventListener("input", saveState);
      amountInput.addEventListener("input", saveState);
      dateInput.addEventListener("input", saveState);
      freqSelect.addEventListener("change", saveState);

      nameDiv.appendChild(nameInput);
      amountDiv.appendChild(amountInput);
      dateDiv.appendChild(dateInput);
      freqDiv.appendChild(freqSelect);
      buttonDiv.appendChild(removeBtn);

      row.appendChild(nameDiv);
      row.appendChild(amountDiv);
      row.appendChild(dateDiv);
      row.appendChild(freqDiv);
      row.appendChild(buttonDiv);

      expensesContainer.appendChild(row);
    }

    // ---- Calculation helpers ----
    function normalizeItems(rawList, defaultName) {
      return rawList
        .map(item => {
          const amount = parseFloat(item.amount) || 0;
          const name = (item.name || "").trim() || defaultName;
          let freq = item.freq || "monthly";
          let dateObj = null;
          const dateStr = item.nextDate || "";

          if (dateStr) {
            // Interpret date input as local date
            const d = new Date(dateStr + "T00:00:00");
            if (!isNaN(d.getTime())) {
              dateObj = d;
            }
          }

          if (!dateObj) {
            // If no valid date, treat as prorated
            freq = "prorated";
          }

          return {
            name,
            amount,
            freq,
            date: dateObj,
            nextDateStr: dateStr
          };
        })
        .filter(i => i.amount > 0);
    }

    function calculateForItems(items) {
      let totalMonth = 0;
      let totalSoFar = 0;
      const breakdown = [];

      items.forEach(item => {
        const { name, amount, freq, date, nextDateStr } = item;
        let monthTotal = 0;
        let paidSoFar = 0;

        if (amount <= 0) {
          breakdown.push({ name, nextDateStr, freq, monthTotal, paidSoFar });
          return;
        }

        if (freq === "prorated") {
          monthTotal = amount;
          paidSoFar = amount * fractionOfMonth;
        } else if (freq === "once") {
          if (date &&
              date.getFullYear() === year &&
              date.getMonth() === monthIndex) {
            monthTotal = amount;
            paidSoFar = date <= today ? amount : 0;
          }
        } else if (freq === "weekly" || freq === "biweekly") {
          const stepDays = (freq === "weekly") ? 7 : 14;
          const occ = getOccurrencesStepDays(date, stepDays);
          const countInMonth = occ.length;
          const countPaid = occ.filter(d => d <= today).length;
          monthTotal = amount * countInMonth;
          paidSoFar = amount * countPaid;
        } else if (freq === "monthly") {
          const occ = getMonthlyOccurrences(date);
          const countInMonth = occ.length;
          const countPaid = occ.filter(d => d <= today).length;
          monthTotal = amount * countInMonth;
          paidSoFar = amount * countPaid;
        }

        totalMonth += monthTotal;
        totalSoFar += paidSoFar;

        breakdown.push({
          name,
          nextDateStr,
          freq,
          monthTotal,
          paidSoFar
        });
      });

      return { totalMonth, totalSoFar, breakdown };
    }

    // ---- Event handlers ----
    addIncomeBtn.addEventListener("click", () => {
      addIncomeRow();
      saveState();
    });

    addExpenseBtn.addEventListener("click", () => {
      addExpenseRow();
      saveState();
    });

    calcBtn.addEventListener("click", () => {
      saveState();

      const incomesRaw = getCurrentIncomes();
      const expensesRaw = getCurrentExpenses();

      const incomes = normalizeItems(incomesRaw, "Income");
      const expenses = normalizeItems(expensesRaw, "Expense");

      const incomeCalc = calculateForItems(incomes);
      const expenseCalc = calculateForItems(expenses);

      const totalIncome = incomeCalc.totalMonth;
      const totalExpenses = expenseCalc.totalMonth;
      const netMonth = totalIncome - totalExpenses;

      const incomeSoFar = incomeCalc.totalSoFar;
      const expensesSoFar = expenseCalc.totalSoFar;
      const netToday = incomeSoFar - expensesSoFar;

      summarySection.style.display = "block";
      progressTextEl.textContent =
        "Recurring items are calculated based on how many occurrences fall in this month and how many of those have passed as of today. Blank dates are treated as evenly spread across the month.";

      totalIncomeEl.textContent = formatMoney(totalIncome);
      totalExpensesEl.textContent = formatMoney(totalExpenses);
      netMonthEl.textContent = formatMoney(netMonth);

      incomeSoFarEl.textContent = formatMoney(incomeSoFar);
      expensesSoFarEl.textContent = formatMoney(expensesSoFar);
      netTodayEl.textContent = formatMoney(netToday);

      // Income breakdown table
      incomeTableBody.innerHTML = "";
      incomeCalc.breakdown.forEach(i => {
        const tr = document.createElement("tr");
        const tdName = document.createElement("td");
        const tdDate = document.createElement("td");
        const tdFreq = document.createElement("td");
        const tdMonth = document.createElement("td");
        const tdSoFar = document.createElement("td");

        tdName.textContent = i.name;
        tdDate.className = "center";
        tdFreq.className = "center";
        tdMonth.className = "right";
        tdSoFar.className = "right";

        const d = i.nextDateStr ? new Date(i.nextDateStr + "T00:00:00") : null;
        tdDate.textContent = formatDateDisplay(d);
        tdFreq.textContent = FREQ_LABELS[i.freq] || i.freq;
        tdMonth.textContent = formatMoney(i.monthTotal);
        tdSoFar.textContent = formatMoney(i.paidSoFar);

        tr.appendChild(tdName);
        tr.appendChild(tdDate);
        tr.appendChild(tdFreq);
        tr.appendChild(tdMonth);
        tr.appendChild(tdSoFar);
        incomeTableBody.appendChild(tr);
      });
      incomeTableSection.style.display = incomes.length ? "block" : "none";

      // Expense breakdown table
      expenseTableBody.innerHTML = "";
      expenseCalc.breakdown.forEach(e => {
        const tr = document.createElement("tr");
        const tdName = document.createElement("td");
        const tdDate = document.createElement("td");
        const tdFreq = document.createElement("td");
        const tdMonth = document.createElement("td");
        const tdSoFar = document.createElement("td");

        tdName.textContent = e.name;
        tdDate.className = "center";
        tdFreq.className = "center";
        tdMonth.className = "right";
        tdSoFar.className = "right";

        const d = e.nextDateStr ? new Date(e.nextDateStr + "T00:00:00") : null;
        tdDate.textContent = formatDateDisplay(d);
        tdFreq.textContent = FREQ_LABELS[e.freq] || e.freq;
        tdMonth.textContent = formatMoney(e.monthTotal);
        tdSoFar.textContent = formatMoney(e.paidSoFar);

        tr.appendChild(tdName);
        tr.appendChild(tdDate);
        tr.appendChild(tdFreq);
        tr.appendChild(tdMonth);
        tr.appendChild(tdSoFar);
        expenseTableBody.appendChild(tr);
      });
      expenseTableSection.style.display = expenses.length ? "block" : "none";
    });

    resetBtn.addEventListener("click", () => {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {
        console.warn("Unable to clear budget data:", e);
      }
      summarySection.style.display = "none";
      incomeTableSection.style.display = "none";
      expenseTableSection.style.display = "none";
      loadState();
    });

    // ---- Initialize ----
    loadState();
  </script>
</body>
</html>
